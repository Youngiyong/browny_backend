service: browny-backend
plugins:
  - serverless-webpack
  - serverless-offline
configValidationMode: error
frameworkVersion: '2'
# env 파일 사용
custom:
  # service application 내 전역적으로 사용하는 서비스 네임, 기본 리소스명이기도 함
  SERVICE_NAME: ${self:service}-${self:provider.stage}
  webpack:
    webpackConfig: 'webpack.config.js'
    packager: 'yarn'
    includeModules: true

provider:
  name: aws
  runtime: nodejs12.x
  region: ap-northeast-2
  lambdaHashingVersion: 20201221
  stage: ${opt:stage, 'dev'}
  deploymentBucket:
    blockPublicAccess: true # Prevents public access via ACLs or bucket policies. Default is false
    name: browny-deploy # Deployment bucket name. Default is generated by the framework
    maxPreviousDeploymentArtifacts: 5 # On every deployment the framework prunes the bucket to remove artifacts older than this limit. The default is 5
  tracing:
    lambda: true
    apiGateway: true
  # regional endpoint는 security group으로 접근 제한을 할 수 없다.
  # https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/apigateway-private-apis.html
  # endpointType: REGIONAL
  apiGateway:
    apiKeySourceType: HEADER
    shouldStartNameWithService: true
    resourcePolicy:
      - Effect: Allow
        Principal: '*'
        Action: execute-api:Invoke
        Resource: "execute-api:/*"
  environment:
    DEBUG: true
    # https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-reusing-connections.html
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
    # 기본 : 배포설정, argements 로 입력
    STAGE: ${self:provider.stage}
    # 기본 : labda 타임존 설정
    TZ: "Asia/Seoul"

    # 리소스 설정
    RDS_PORT: 5432
    RDS_DATABASE: browny
    RDS_USERNAME: browny
    RDS_PASSWORD: brwony.cwb7hmxfs0pp.ap-northeast-2.rds.amazonaws.com
    # S3_AWS_ACCESS_KEY_ID: ${env:S3_AWS_ACCESS_KEY_ID}
    # S3_AWS_SECRET_ACCESS_KEY: ${env:S3_AWS_SECRET_ACCESS_KEY}
    # GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID}
    # GOOGLE_CLIENT_SECRET: ${env:GOOGLE_CLIENT_SECRET}

  vpc:
    securityGroupIds:
      - sg-0c26def52725027a2
    subnetIds:
      - subnet-068eb19616780adb7 #public-subnet-a
      - subnet-0a5fe2e2a9acd001d #public-subnet-b

  iamRoleStatements:
    - Effect: Allow
      Action:
        - "sns:*"
      Resource: "*"
    - Effect: Allow
      Action:
        - "sqs:*"
      Resource: "*"
    - Effect: Allow
      Action:
        - "apigateway:*"
      Resource: "*"
          Resource: "*"
functions:
  hello:
    handler: src/handler.hello
    events:
      - http:
          path: hello
          method: get
# resources:
#   Description: auth_email
#   Resources:
#     MyroMemberTable:
#       Type: AWS::DynamoDB::Table
#       Properties:
#         TableName: auth_email
#         AttributeDefinitions:
#           - AttributeName: "id"
#             AttributeType: "S"
#         KeySchema:
#           - AttributeName: "id"
#             KeyType: HASH
#         ProvisionedThroughput:
#           ReadCapacityUnits: 1
#           WriteCapacityUnits: 1